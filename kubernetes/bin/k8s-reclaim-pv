#!/usr/bin/env bash

# K8S Reclaim Persistent Volume
# =============================
# Tim Friske <me@tifr.de>
#
# Reclaims the given persistent volume by changing its reclaim policy to the
# given value.
#
# Deps:: bash, env, kubectl

# Ensure fail-fast script execution.
shopt -os nounset pipefail errexit errtrace

# Input parameters and validation:
pv="${1:-"${pv:?required}"}"
policy="${2:-"${policy:?required}"}"
case "${policy}" in
  [Dd]elete|[Rr]ecycle|[Rr]etain);;
  *)
    echo >&2 "Reclaim policy is invalid: ${policy}"
    echo >&2 "Reclaim policy must be either one of (case-insenitive): Delete Recycle Retain"
    echo >&2 "Aborting with non-zero exit code 1..."
    exit 1
    ;;
esac

kubectl patch persistentvolume "${pv}" \
  --patch "{\"spec\":{\"persistentVolumeReclaimPolicy\":\"${policy^}\"}}"
