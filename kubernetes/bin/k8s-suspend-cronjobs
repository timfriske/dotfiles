#!/usr/bin/env bash

# K8S Suspend Cronjobs
# ====================
# Tim Friske <me@tifr.de>
#
# Lets users interactively filter and select from a list of Kubernetes
# cronjobs the ones whose suspension state to toggle either on or off.
#
# Deps:: awk, bash, env, fzf, kubectl, parallel, sed

# Ensure fail-fast script execution.
shopt -os nounset pipefail errexit errtrace

suspension_toggle='{\"spec\":{\"suspend\":{2}}}'

function pick {
  local bindings=(
    'ctrl-a:toggle-all'
    'ctrl-z:clear-selection'
  )
  fzf --bind="$(IFS=,; printf '%s' "${bindings[*]}")" "${@}"
}

kubectl get cronjobs \
    --output custom-columns='NAME:{metadata.name},SUSPEND:{spec.suspend}' \
  | sed --regexp-extended --expression='s:\b(false|true)\b:\u\1:' \
  | pick --header-lines=1 --cycle --multi --exit-0 \
  | awk '{$2=="False"?$2="true":$2="false";print}' \
  | parallel --jobs 1 --colsep '\s+' -- \
    kubectl patch cronjob "{1}" --patch "${suspension_toggle}"
