#!/usr/bin/env sh

# Git Who command
# ===============
# Tim Friske <me@tifr.de>
#
# Shows the user's name, email and signing key. With recent versions of
# Git also a setting's origin and scope are displayed next to it.
#
# Deps:: awk, column, env, git-config, git-semver, sh

set -o errexit -o nounset

tabulator="$(printf '\t')"

awk_tab() {
  awk -v FS="${tabulator}" -v OFS="${tabulator}" "${@}"
}

git_config_show() {
  git config --show-origin "${1}.${2:+${2}.}${3}" \
  | awk_tab -v "title=${1}${2:+${2}} ${3}" \
      '{
        idx=split($1,origin,"/")
        print title":",$2,"("origin[idx]")"
      }'
}

git_config_show_scope() {
  git config --show-origin --show-scope "${1}.${2:+${2}.}${3}" \
  | awk_tab -v "title=${1}${2:+${2}} ${3}" \
      '{
        idx=split($2,origin,"/")
        print title":",$3,"("$1" "origin[idx]")"
      }'
}

git_config_user() {
  subsection="${1:-}"
  if [ "$(git semver major)" -le 2 ]; then
    if [ "$(git semver minor)" -lt 26 ]; then
      for option in Name Email SigningKey; do
        git_config_show User "${subsection}" "${option}"
      done
      return
    fi
  fi
  for option in Name Email SigningKey; do
    git_config_show_scope User "${subsection}" "${option}"
  done
}

main() {
    # `column -t -s` equivalent to `column --table --separator`
    git_config_user "${1:-}" | column -t -s "${tabulator}"
}

main "${@}"
