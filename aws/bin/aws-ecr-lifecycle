#!/usr/bin/env bash

# AWS ECR Lifecycle command
# =========================
# Tim Friske <me@tifr.de>
#
# Applies AWS ECR lifecycle policies from the given json file to the
# given repositories of current registry.
#
# Deps:: aws, bash, env, jq

# Ensure fail-fast script execution.
shopt -os nounset pipefail errexit errtrace

function main {
  : "${1:?usage: aws-ecr-lifecycle <lifecycle-json-file> <repository name>...}"
  local repository_name lifecycle_json_file="file://${1#file://}"
  for repository_name in "${@:2}"; do
    aws ecr put-lifecycle-policy \
      --output json \
      --repository-name "${repository_name}" \
      --lifecycle-policy-text "${lifecycle_json_file}" \
    | jq '. + {lifecyclePolicyText: .lifecyclePolicyText|fromjson}'
  done
}

main "${@}"
