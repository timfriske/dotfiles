#!/usr/bin/env bash

# AWS EKS Addon Latest Compat command
# ===================================
# Tim Friske <me@tifr.de>
#
# Prints the latest version of the given AWS EKS addon that is compatible with
# the given AWS EKS Kubernetes version.
#
# For example: aws-eks-addon-latest-compat aws-ebs-csi-driver 1.25
#
# Deps:: aws, bash, env

# Ensure fail-fast script execution.
shopt -os nounset pipefail errexit errtrace

aws_eks_addon="${1:-"${aws_eks_addon:?required}"}"
aws_eks_kubernetes_version="${2:-"${aws_eks_kubernetes_version:?required}"}"
aws eks describe-addon-versions --addon-name "${aws_eks_addon}" \
  | jq --raw-output --arg cv "${aws_eks_kubernetes_version}" \
    '.addons[0].addonVersions[]|select(.compatibilities[]|.clusterVersion==$cv and .defaultVersion==true).addonVersion'
