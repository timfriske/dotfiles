#!/usr/bin/env bash

# AWS ECR Repo Names command
# ==========================
# Tim Friske <me@tifr.de>
#
# Prints the names of AWS ECR repositories (repo) sorted by name in the registry
# of the account optionally selecting the repos by the given regular expressions
# (regex). When giving multiple regexes at least one of them must match (any;
# logical OR).
#
# Deps:: aws, bash, cat, env, jq

# Ensure fail-fast script execution.
shopt -os nounset noclobber pipefail errexit errtrace

# Input parameters and validation:
names=("${@}") # optional

function repo_names {
  aws ecr describe-repositories --output json | jq '.repositories|map(.repositoryName)|sort'
}

function select_by_name {
  local names=("${@}") # optional
  if [[ "${#names[@]}" -gt 0 ]]; then
    jq 'map(select(. as $name|$ARGS.positional|any(. as $arg|$name|test($arg;"i"))))' --args -- "${names[@]}"
  else
    cat
  fi
}

repo_names | select_by_name "${names[@]}"
